const EVENTS={join:"join",leave:"leave",message:"message"},STALE_CONNECTION_THRESHOLD_SECONDS=100,SOCKET_POLLING_RATE=1e4;let now=()=>(new Date).getTime(),secondsSince=t=>(now()-t)/1e3;export class Channel{constructor(t,e){this.topic=t,this.socket=e,this.onMessageHandlers=[]}join(){this.socket.ws.send(JSON.stringify({event:EVENTS.join,topic:this.topic}))}leave(){this.socket.ws.send(JSON.stringify({event:EVENTS.leave,topic:this.topic}))}handleMessage(t){this.onMessageHandlers.forEach(e=>{e.subject===t.subject&&e.callback(t.payload)})}on(t,e){this.onMessageHandlers.push({subject:t,callback:e})}push(t,e){this.socket.ws.send(JSON.stringify({event:EVENTS.message,topic:this.topic,subject:t,payload:e}))}}export class Socket{constructor(t){this.endpoint=t,this.ws=null,this.channels=[],this.lastPing=now(),this.reconnectTries=0,this.attemptReconnect=!0}_connectionIsStale(){return secondsSince(this.lastPing)>STALE_CONNECTION_THRESHOLD_SECONDS}_reconnect(){clearTimeout(this.reconnectTimeout),this.reconnectTimeout=setTimeout(()=>{this.reconnectTries++,this.connect(this.params),this._reconnect()},this._reconnectInterval())}_reconnectInterval(){return[1e3,2e3,5e3,1e4][this.reconnectTries]||1e4}_poll(){this.pollingTimeout=setTimeout(()=>{this._connectionIsStale()?this._reconnect():this._poll()},SOCKET_POLLING_RATE)}_startPolling(){clearTimeout(this.pollingTimeout),this._poll()}_handlePing(){this.lastPing=now()}_reset(){clearTimeout(this.reconnectTimeout),this.reconnectTries=0,this.attemptReconnect=!0,this._startPolling()}connect(t){this.params=t;let e={location:window.location.hostname,port:window.location.port,protocol:"https:"===window.location.protocol?"wss:":"ws:"};return t&&Object.assign(e,t),e.port&&(e.location+=`:${e.port}`),new Promise((t,n)=>{this.ws=new WebSocket(`${e.protocol}//${e.location}${this.endpoint}`),this.ws.onmessage=(t=>{this.handleMessage(t)}),this.ws.onclose=(()=>{this.attemptReconnect&&this._reconnect()}),this.ws.onopen=(()=>{this._reset(),t()})})}disconnect(){this.attemptReconnect=!1,clearTimeout(this.pollingTimeout),clearTimeout(this.reconnectTimeout),this.ws.close()}channel(t){let e=new Channel(t,this);return this.channels.push(e),e}handleMessage(t){if("ping"===t.data)return this._handlePing();let e=JSON.parse(t.data);this.channels.forEach(t=>{t.topic===e.topic&&t.handleMessage(e)})}}export default{Channel:Channel,Socket:Socket};document.addEventListener("DOMContentLoaded",()=>{let t=document.querySelectorAll("a[data-method='delete']");for(let e=0;e<t.length;e++)t[e].addEventListener("click",t=>{t.preventDefault();let e=t.target.getAttribute("data-confirm")||"Are you sure?";if(confirm(e)){let e=document.createElement("form"),n=document.createElement("input");e.setAttribute("action",t.target.getAttribute("href")),e.setAttribute("method","POST"),n.setAttribute("type","hidden"),n.setAttribute("name","_method"),n.setAttribute("value","DELETE"),e.appendChild(n),document.body.appendChild(e),e.submit()}return!1})}),Date.prototype.toGranite||function(){function t(t){return t<10?"0"+t:t}Date.prototype.toGranite=function(){return this.getUTCFullYear()+"-"+t(this.getUTCMonth()+1)+"-"+t(this.getUTCDate())+" "+t(this.getUTCHours())+":"+t(this.getUTCMinutes())+":"+t(this.getUTCSeconds())}}();
